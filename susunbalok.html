<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Susun Balok Ajaib</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* style.css content goes here */
        :root {
            --primary-color: #FF6B6B; /* Merah untuk Saldo & Error */
            --secondary-color: #5E6BFF; /* Biru untuk Background Gradien */
            --tertiary-color: #6BFF6B; /* Hijau untuk Sukses & Skor */
            --accent-color: #00FFFF; /* Cyan untuk Judul & Border */
            --text-light: #fff;
            --text-dark: #000;
            --canvas-bg: #1a1a1a; /* Background area permainan */
            --border-glow: #00FFFF; /* Border luar game container */
            --button-bg: #00FFFF; /* Warna tombol default */
            --button-active: #00BFFF; /* Warna tombol saat ditekan */
        }

        body {
            margin: 0;
            overflow: hidden; /* Sembunyikan scrollbar jika canvas melebihi viewport */
            font-family: 'Press Start 2P', cursive; /* Gunakan font Press Start 2P */
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Background gradien animasi */
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--tertiary-color), var(--primary-color));
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            padding: 10px;
            box-sizing: border-box;
            user-select: none; /* Mencegah seleksi teks */
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animasi untuk perubahan saldo */
        @keyframes balance-gain {
            0% { transform: scale(1); color: var(--primary-color); }
            50% { transform: scale(1.3); color: var(--tertiary-color); text-shadow: 0 0 10px var(--tertiary-color); }
            100% { transform: scale(1); color: var(--primary-color); text-shadow: none; }
        }

        @keyframes balance-loss {
            0% { transform: scale(1); color: var(--primary-color); }
            50% { transform: scale(1.3); color: #FF4444; text-shadow: 0 0 10px #FF4444; } /* Merah yang lebih menonjol */
            100% { transform: scale(1); color: var(--primary-color); text-shadow: none; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5); /* Background transparan */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.7); /* Efek glow */
            border: 3px solid var(--border-glow);
            width: 90%;
            max-width: 450px; /* Lebar Maksimum untuk Tampilan Desktop/Tablet */
            box-sizing: border-box;
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        h1 {
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .info-item {
            font-size: 1em;
            margin: 5px 0;
            white-space: nowrap; /* Mencegah teks pecah baris */
        }
        .info-item #score {
            color: var(--tertiary-color);
            font-weight: bold;
        }
        .info-item #balance {
            color: var(--primary-color); /* Warna default saldo */
            font-weight: bold;
            font-size: 1.2em;
            display: inline-block; /* Penting untuk animasi scale */
            transition: color 0.1s ease-out; /* Transisi warna lebih halus */
        }
        /* Class untuk mengaktifkan animasi saldo */
        .info-item #balance.animate-gain {
            animation: balance-gain 0.5s ease-out;
        }
        .info-item #balance.animate-loss {
            animation: balance-loss 0.5s ease-out;
        }

        /* Styling untuk area informasi pemain (banner) */
        .player-banner {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9em;
            color: var(--accent-color);
            text-align: left; /* Teks rata kiri */
        }
        .player-banner p {
            margin: 0;
            padding: 2px 0;
        }
        .player-banner .player-name {
            font-weight: bold;
            color: var(--tertiary-color);
        }
        .player-banner .player-status {
            font-size: 0.8em;
            color: #ccc;
        }
canvas {
    background-color: var(--canvas-bg);
    border: 2px solid var(--accent-color);
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    width: 300px;
    height: 325px;
    display: block;
    max-width: 400px;
}

        .controls {
            display: grid;
            grid-template-areas:
                ". rotate ."
                "left softdrop right"
            ;
            grid-template-columns: 1fr 1fr 1fr; /* Lebar kolom yang sama */
            gap: 10px; /* Jarak antar tombol */
            width: 100%;
            margin-top: 20px;
        }

        .controls button {
            background-color: var(--button-bg);
            color: var(--text-dark);
            border: none;
            padding: 15px 0;
            font-size: 1.5em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px; /* Tinggi tetap untuk tombol */
            box-shadow: 0 4px 0 var(--button-active); /* Efek 3D */
            -webkit-tap-highlight-color: transparent; /* Hilangkan highlight di Android saat tap */
        }

        .controls button:active {
            background-color: var(--button-active);
            transform: translateY(2px); /* Tombol sedikit ke bawah */
            box-shadow: 0 2px 0 var(--button-active); /* Shadow berkurang */
        }

        /* Penempatan tombol di grid */
        #moveLeftBtn { grid-area: left; }
        #rotateBtn { grid-area: rotate; }
        #moveRightBtn { grid-area: right; }
        #softDropBtn { grid-area: softdrop; }

        #backToProfileBtn {
            margin-top: 20px;
            width: 100%;
            background-color: #FFD700; /* Warna emas/kuning untuk tombol profil */
            color: #333;
            font-size: 1.2em;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 0 #CCAA00;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
        }

        #backToProfileBtn:active {
            background-color: #CCAA00;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #997A00;
        }


        .message-area {
            margin-top: 15px;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-light);
            min-height: 25px; /* Agar tidak 'meloncat' saat pesan muncul/hilang */
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .message-area.info {
            color: var(--accent-color);
        }
        .message-area.success {
            color: var(--tertiary-color);
        }
        .message-area.error {
            color: var(--primary-color);
        }

        /* Media Queries untuk Layar Ponsel */
        @media (max-width: 600px) {
            .game-container {
                width: 98%;
                padding: 10px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.3em;
            }

            .info-item {
                font-size: 0.9em;
            }
            .info-item #balance {
                font-size: 1.1em;
            }

            .controls button {
                padding: 10px 0;
                font-size: 1.2em;
                height: 50px;
                border-radius: 6px;
            }
            .message-area {
                font-size: 0.9em;
            }
            #backToProfileBtn {
                font-size: 1em;
                padding: 12px 20px;
            }
            .player-banner {
                font-size: 0.8em;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="player-banner">
            <p>Pemain: <span id="playerName" class="player-name">Memuat...</span></p>
            <p>Status: <span id="playerStatus" class="player-status">Memeriksa Login...</span></p>
        </div>

        <div class="game-info">
            <h1>Susun Balok Ajaib</h1>
            <p class="info-item">Skor: <span id="score">0</span></p>
            <p class="info-item">Saldo: <span id="balance">Memuat...</span></p>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="controls">
            <button id="moveLeftBtn" class="control-btn">←</button>
            <button id="rotateBtn" class="control-btn">↻</button>
            <button id="moveRightBtn" class="control-btn">→</button>
            <button id="softDropBtn" class="control-btn">↓</button>
        </div>
        <button id="backToProfileBtn" style="display:none;">Kembali ke Profil</button>
        <div id="message-area" class="message-area"></div>
    </div>

    <audio id="clickSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
    <audio id="lineClearSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-mechanical-crate-pick-up-3154%20(1).mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//dj-background-music-background-music-free-music-music-free-for-use-221916%20(1).mp3" preload="auto" loop></audio>

    <script>
        // --- Supabase Configuration (GANTI DENGAN KREDENSIAL ASLI ANDA) ---
        const SUPABASE_URL = 'https://vqmfachxnjyxwuavpgds.supabase.co'; // GANTI INI DENGAN URL SUPABASE ANDA
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      

        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const balanceDisplay = document.getElementById('balance');
        const messageArea = document.getElementById('message-area');
        const playerNameDisplay = document.getElementById('playerName');
        const playerStatusDisplay = document.getElementById('playerStatus');

        // Dapatkan tombol kontrol
        const moveLeftBtn = document.getElementById('moveLeftBtn');
        const rotateBtn = document.getElementById('rotateBtn');
        const moveRightBtn = document.getElementById('moveRightBtn');
        const softDropBtn = document.getElementById('softDropBtn');
        const backToProfileBtn = document.getElementById('backToProfileBtn');

        // Konfigurasi Game Board
        const TILE_SIZE = 35; // Ukuran setiap "kotak" balok dalam piksel
        const BOARD_WIDTH = 10; // Lebar papan (jumlah kotak)
        const BOARD_HEIGHT = 20; // Tinggi papan (jumlah kotak)

        // Sesuaikan ukuran canvas berdasarkan TILE_SIZE dan BOARD_DIMENSIONS
        canvas.width = BOARD_WIDTH * TILE_SIZE; // Seharusnya 10 * 35 = 350px
        canvas.height = BOARD_HEIGHT * TILE_SIZE; // Seharusnya 20 * 35 = 700px

        // Variabel Game State
        let score = 0;
        let currentBalance = 0; // Saldo pemain, akan disinkronkan dengan Supabase
        let currentUser = null; // Objek user Supabase yang sedang login
        let gameRunning = false;
        let board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
        let currentPiece = null;
        let currentX = 0;
        let currentY = 0;

        // Dapatkan elemen audio
        const clickSound = document.getElementById('clickSound');
        const lineClearSound = document.getElementById('lineClearSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // Fungsi untuk memutar suara
        function playSound(audioElement) {
            if (audioElement) {
                audioElement.currentTime = 0; // Mengatur ulang suara ke awal
                audioElement.play().catch(e => console.warn("Audio Playback Warning:", e.message));
            }
        }

        // Fungsi untuk memulai musik latar
        function playBackgroundMusic() {
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => {
                    console.warn("Autoplay of background music blocked. User interaction required. Error:", e.message);
                });
            }
        }

        // --- Supabase Integration Functions ---

        async function initializeUserAndSaldo() {
            playerNameDisplay.textContent = 'Memuat...';
            playerStatusDisplay.textContent = 'Memeriksa Login...';
            showMessage('Memeriksa sesi pengguna...', 'info');

            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError) {
                    console.error('Supabase Auth Error:', authError.message);
                    playerStatusDisplay.textContent = 'Auth Error';
                    showMessage(`Gagal otentikasi: ${authError.message}. Silakan login ulang.`, 'error');
                    // Arahkan kembali ke halaman login jika autentikasi gagal
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                    return;
                }

                if (user) {
                    currentUser = user;
                    playerNameDisplay.textContent = user.user_metadata?.username || user.email || 'Pemain';
                    playerStatusDisplay.textContent = 'Login';
                    console.log('User logged in:', currentUser.id);
                    await fetchSaldo(); // Lanjutkan ambil saldo
                } else {
                    console.warn('No active user session. Redirecting to login.');
                    playerStatusDisplay.textContent = 'Tidak Login';
                    showMessage('Anda belum login. Mengarahkan ke halaman login...', 'info');
                    // Arahkan ke halaman login jika tidak ada sesi aktif
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                }
            } catch (error) {
                console.error('Unexpected error during user initialization:', error.message);
                playerStatusDisplay.textContent = 'Error Inisialisasi';
                showMessage(`Error inisialisasi user: ${error.message}. Periksa Supabase config/CORS.`, 'error');
                gameOver(); // Berhenti jika gagal inisialisasi user
            }
        }

        async function fetchSaldo() {
            if (!currentUser) {
                showMessage('Error: Tidak ada user aktif untuk mengambil saldo.', 'error');
                return;
            }
            showMessage('Memuat saldo pemain...', 'info');
            balanceDisplay.textContent = 'Memuat...';

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .select('saldo, username') // Ambil username juga jika perlu
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error fetching saldo:', error.message);
                    if (error.code === 'PGRST116' || error.message.includes('0 rows')) { // "No rows found" - User belum ada di tabel users_data
                        console.warn('User entry not found in users_data. Creating new entry with default saldo...');
                        const usernameFromMeta = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Unknown';
                        await createNewUserEntryWithDefaultSaldo(currentUser.id, currentUser.email, usernameFromMeta);
                        // Coba fetch saldo lagi setelah membuat entry baru
                        await fetchSaldo();
                    } else {
                        showMessage(`Gagal memuat saldo: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        balanceDisplay.textContent = 'Gagal';
                        gameOver(); // Berhenti jika gagal load saldo
                    }
                    return;
                }

                if (data) {
                    currentBalance = data.saldo || 0;
                    balanceDisplay.textContent = currentBalance;
                    playerNameDisplay.textContent = data.username || currentUser.user_metadata?.username || currentUser.email || 'Pemain';
                    showMessage('Saldo dimuat!', 'success');
                    console.log('Saldo fetched:', currentBalance);

                    if (currentBalance > 0) {
                        startGame(); // Mulai game hanya jika saldo > 0
                    } else {
                        showMessage('Saldo Anda 0. Top up untuk bermain!', 'error');
                        gameOver(); // Game Over jika saldo 0
                    }
                }

            } catch (err) {
                console.error('Unexpected error in fetchSaldo:', err);
                showMessage('Terjadi kesalahan tak terduga saat memuat saldo.', 'error');
                balanceDisplay.textContent = 'Error';
                gameOver();
            }
        }

        async function createNewUserEntryWithDefaultSaldo(userId, email, username) {
            const DEFAULT_STARTING_SALDO = 500; // Saldo default untuk user baru

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .insert([
                        { user_id: userId, saldo: DEFAULT_STARTING_SALDO, email: email, username: username, peran: 'Players_Guest' }
                    ]);

                if (error) {
                    console.error('Error creating new user entry:', error.message);
                    showMessage(`Gagal membuat entry user baru: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                    return false;
                }
                console.log('New user entry created with default saldo:', DEFAULT_STARTING_SALDO);
                currentBalance = DEFAULT_STARTING_SALDO; // Update saldo lokal juga
                balanceDisplay.textContent = currentBalance;
                showMessage('User baru dibuat dengan saldo awal!', 'success');
                return true;
            } catch (err) {
                console.error('Unexpected error in createNewUserEntryWithDefaultSaldo:', err);
                showMessage('Terjadi kesalahan tak terduga saat membuat user baru.', 'error');
                return false;
            }
        }

        let updateSaldoTimeout; // Variabel untuk debounce update saldo
        async function updateSaldo() {
            if (!currentUser) {
                console.warn('Cannot update saldo: No user logged in.');
                return;
            }

            // Mencegah terlalu banyak update ke DB
            clearTimeout(updateSaldoTimeout);
            updateSaldoTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabase
                        .from('users_data')
                        .update({ saldo: currentBalance })
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error updating saldo:', error.message);
                        showMessage(`Gagal update saldo: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        return;
                    }
                    console.log('Saldo updated successfully to DB:', currentBalance);
                } catch (err) {
                    console.error('Unexpected error in updateSaldo:', err);
                    showMessage('Terjadi kesalahan tak terduga saat update saldo.', 'error');
                }
            }, 500); // Tunggu 500ms sebelum update ke DB
        }


        // Definisi bentuk balok (Tetromino) dan propertinya
        const TETROMINOS = [
            {
                shape: [[0, 1, 0], [1, 1, 1], [0, 0, 0]], // T
                color: '#FF00FF', // Magenta
                cost: 5, // Biaya saat balok ini muncul
                clear_value_per_block: 1 // Saldo per kotak saat baris pecah
            },
            {
                shape: [[1, 1, 0], [0, 1, 1], [0, 0, 0]], // S
                color: '#00FF00', // Hijau
                cost: 4,
                clear_value_per_block: 1
            },
            {
                shape: [[0, 1, 1], [1, 1, 0], [0, 0, 0]], // Z
                color: '#FF0000', // Merah
                cost: 4,
                clear_value_per_block: 1
            },
            {
                shape: [[1, 1], [1, 1]], // O
                color: '#FFFF00', // Kuning
                cost: 3,
                clear_value_per_block: 1
            },
            {
                shape: [[1, 0, 0], [1, 1, 1], [0, 0, 0]], // L
                color: '#FFA500', // Oranye
                cost: 5,
                clear_value_per_block: 1
            },
            {
                shape: [[0, 0, 1], [1, 1, 1], [0, 0, 0]], // J
                color: '#0000FF', // Biru
                cost: 5,
                clear_value_per_block: 1
            },
            {
                shape: [[1], [1], [1], [1]], // I
                color: '#00FFFF', // Cyan
                cost: 6,
                clear_value_per_block: 1
            }
        ];

        // --- Fungsi Helper UI ---
        function showMessage(msg, type = 'info') {
            messageArea.textContent = msg;
            messageArea.className = `message-area ${type}`;
            setTimeout(() => {
                messageArea.textContent = '';
                messageArea.className = `message-area`;
            }, 3000);
        }

        function addBalanceAnimation(type) {
            balanceDisplay.classList.remove('animate-gain', 'animate-loss');
            void balanceDisplay.offsetWidth; // Trigger reflow
            balanceDisplay.classList.add(`animate-${type}`);
        }

        // --- Fungsi Game Logic ---

        function getRandomPiece() {
            const randomIndex = Math.floor(Math.random() * TETROMINOS.length);
            return JSON.parse(JSON.stringify(TETROMINOS[randomIndex]));
        }

        function drawBoard() {
            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    if (board[row][col] !== 0) {
                        ctx.fillStyle = board[row][col].color;
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#333';
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#1a1a1a';
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#222';
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }
        function drawPiece(piece, x, y) {
            if (!piece) return;
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        ctx.fillStyle = piece.color;
                        ctx.fillRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#333';
                        ctx.strokeRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }

        function isValidMove(piece, newX, newY) {
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        const boardX = newX + col;
                        const boardY = newY + row;

                        if (boardX < 0 || boardX >= BOARD_WIDTH || boardY >= BOARD_HEIGHT) {
                            return false;
                        }
                        if (boardY >= 0 && board[boardY][boardX] !== 0) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function placePiece() {
            for (let row = 0; row < currentPiece.shape.length; row++) {
                for (let col = 0; col < currentPiece.shape[row].length; col++) {
                    if (currentPiece.shape[row][col]) {
                        if (currentY + row < 0) { // Jika balok menyentuh bagian atas board
                            gameOver();
                            return;
                        }
                        board[currentY + row][currentX + col] = {
                            color: currentPiece.color,
                            clear_value_per_block: currentPiece.clear_value_per_block
                        };
                    }
                }
            }
            clearLines();
            createNewPiece();
        }

        function rotatePiece(piece) {
            const newShape = Array(piece.shape[0].length).fill(null).map(() => Array(piece.shape.length).fill(0));
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    newShape[col][piece.shape.length - 1 - row] = piece.shape[row][col];
                }
            }
            return { ...piece, shape: newShape };
        }

        function clearLines() {
            let linesCleared = 0;
            let coinsEarned = 0;

            for (let row = BOARD_HEIGHT - 1; row >= 0; row--) {
                if (board[row].every(cell => cell !== 0)) {
                    linesCleared++;
                    for (let col = 0; col < BOARD_WIDTH; col++) {
                        coinsEarned += board[row][col].clear_value_per_block || 1;
                    }
                    for (let r = row; r > 0; r--) {
                        board[r] = [...board[r - 1]];
                    }
                    board[0] = Array(BOARD_WIDTH).fill(0);
                    row++; // Periksa baris yang sama lagi karena baris di atasnya sudah turun
                }
            }

            if (linesCleared > 0) {
                playSound(lineClearSound);
                currentBalance += coinsEarned;
                updateBalanceDisplay();
                addBalanceAnimation('gain');
                showMessage(`+${coinsEarned} Saldo dari ${linesCleared} baris!`, 'success');
                updateSaldo(); // <-- Update saldo ke Supabase
            }
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = score;
        }

        function updateBalanceDisplay() {
            balanceDisplay.textContent = currentBalance;
        }

        function createNewPiece() {
            currentPiece = getRandomPiece();
            currentY = 0;
            currentX = Math.floor(BOARD_WIDTH / 2) - Math.floor(currentPiece.shape[0].length / 2);

            if (currentBalance < currentPiece.cost) {
                showMessage('Saldo tidak cukup untuk balok ini!', 'error');
                gameOver();
                return;
            }
            currentBalance -= currentPiece.cost;
            updateBalanceDisplay();
            addBalanceAnimation('loss');
            showMessage(`-${currentPiece.cost} Saldo. Sisa: ${currentBalance}`, 'info');
            updateSaldo(); // <-- Update saldo ke Supabase

            if (!isValidMove(currentPiece, currentX, currentY)) {
                gameOver(); // Game Over jika balok baru tidak bisa ditempatkan (misal, karena papan penuh)
            }
        }

        let dropInterval = 800; // Balok jatuh setiap 0.8 detik
        let lastDropTime = 0;
        let animationFrameId = null;

        function gameLoop(timestamp) {
            if (!gameRunning) {
                cancelAnimationFrame(animationFrameId);
                return;
            }

            if (!lastDropTime) lastDropTime = timestamp;
            const deltaTime = timestamp - lastDropTime;

            if (deltaTime > dropInterval) {
                if (isValidMove(currentPiece, currentX, currentY + 1)) {
                    currentY++;
                } else {
                    placePiece();
                }
                lastDropTime = timestamp;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
            drawPiece(currentPiece, currentX, currentY);

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameRunning = true;
            board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
            score = 0;
            // currentBalance tidak direset di sini karena diambil dari Supabase
            updateScoreDisplay();
            updateBalanceDisplay();
            messageArea.textContent = '';
            backToProfileBtn.style.display = 'none';

            createNewPiece();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);
            playBackgroundMusic(); // Mulai musik latar saat game dimulai
        }

        function gameOver() {
            gameRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            currentPiece = null;

            showMessage('GAME OVER! Saldo habis atau tidak ada tempat.', 'error');
            console.log('Game Over! Saldo Akhir: ' + currentBalance);

            backToProfileBtn.style.display = 'block';
        }

        // --- Event Listeners for Controls ---

        document.addEventListener('keydown', e => {
            if (!gameRunning || !currentPiece) return;

            let moved = false;
            let newX = currentX;
            let newY = currentY;
            let newPiece = currentPiece;

            if (e.key === 'ArrowLeft') { newX--; moved = true; }
            else if (e.key === 'ArrowRight') { newX++; moved = true; }
            else if (e.key === 'ArrowDown') { newY++; moved = true; lastDropTime = performance.now(); } // Soft drop
            else if (e.key === 'ArrowUp' || e.key === ' ') { newPiece = rotatePiece(currentPiece); moved = true; } // Rotate
            else if (e.key === 'Control' || e.key === 'Enter') { // Hard drop
                while (isValidMove(currentPiece, currentX, currentY + 1)) { currentY++; }
                placePiece(); playSound(clickSound); return;
            }

            if (moved && isValidMove(newPiece, newX, newY)) {
                currentX = newX;
                currentY = newY;
                currentPiece = newPiece;
                playSound(clickSound);
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY);
        });

        // Event listener untuk tombol sentuh
        moveLeftBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX - 1, currentY)) { currentX--; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        rotateBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            const newPiece = rotatePiece(currentPiece);
            if (isValidMove(newPiece, currentX, currentY)) { currentPiece = newPiece; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        moveRightBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX + 1, currentY)) { currentX++; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        softDropBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX, currentY + 1)) { currentY++; lastDropTime = performance.now(); } else { placePiece(); }
            playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY);
        });

        // Tombol Kembali ke Profil
        backToProfileBtn.addEventListener('click', () => {
            window.location.href = 'profil.html';
        });

        // --- Inisialisasi Awal ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeUserAndSaldo(); // Panggil fungsi inisialisasi user dan saldo dari Supabase
        });

        // Pastikan musik latar mulai berputar setelah ada interaksi user
        document.body.addEventListener('click', () => {
            playBackgroundMusic();
        }, { once: true });

    </script>
</body>
</html>
