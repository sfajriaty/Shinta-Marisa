<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil Pemain - GameZone</title>
  <style>
    ('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e3c, #2a5);
      color: #fff;
    }
    .container {
      max-width: 600px;
      margin: 40px auto 80px;
      background: rgba(0,0,0,0.6);
      border-radius: 15px;
      padding: 30px 40px;
      box-shadow: 0 0 25px 4px rgba(255,165,0,0.5);
    }
    h1 {
      text-align: center;
      color: #ff9;
      text-shadow: 0 0 12px #ffb347;
      margin-bottom: 30px;
    }
    .saldo {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 25px;
      color: black;
      background: #f78c;
      border-radius: 25px;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .btn {
      background: #ff95;
      border: none;
      border-radius: 30px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 0 12px #ffb347;
      transition: background 0.3s;
    }
    .btn:hover { background: #ffb347; }
    h2 {
      border-bottom: 2px solid #ff9500;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    table {
      width: 90%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      padding: 10px 10px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    th {
      background: #ff9500;
      color: #222;
    }
    .empty {
      color: #bbb;
      font-style: italic;
      text-align: center;
      padding: 15px 0;
    }
    .status-pending { /* Tambahkan style ini */
        color: orange;
        font-weight: bold;
    }
    .status-approved { /* Tambahkan style ini */
        color: lightgreen;
        font-weight: bold;
    }
    .status-rejected { /* Tambahkan style ini */
        color: red;
        font-weight: bold;
    }
    @media (max-width: 480px) {
      .container {
        margin: 20px 15px 60px;
        padding: 20px 25px;
      }
      .btn-group { flex-direction: column; gap: 12px; }
      .btn { width: 100%; }
    }
    
        .btn.loading {
      position: relative;
      color: transparent; /* Sembunyikan teks tombol */
      pointer-events: none; /* Nonaktifkan klik saat loading */
      background: #ff9500; /* Warna tetap sama atau sedikit gelap */
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 18px;
      height: 18px;
      margin-top: -9px;
      margin-left: -9px;
      border: 3px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  /* --- Modifikasi Umum untuk Popup --- */
.popup-form {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* Gradasi overlay yang lebih halus dan menyatu */
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.75) 0%, rgba(0, 0, 0, 0.6) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Pastikan selalu di atas */
    opacity: 0; /* Awalnya tersembunyi */
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

/* Aktifkan saat popup muncul */
.popup-form[style*="display: flex"] { /* Cek display:flex, ini akan memicu transisi */
    opacity: 1;
    visibility: visible;
}

.popup-inner {
    background: linear-gradient(145deg, #2a5298, #1e3c72); /* Gradasi gelap dari background utama */
    color: #e0e0e0; /* Warna teks lebih terang untuk kontras */
    padding: 10px; /* Tambah padding */
    border-radius: 15px; /* Sudut lebih membulat */
    /* Bayangan lebih modern dan sedikit glow orange */
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 25px 5px rgba(255, 165, 0, 0.3);
    width: 90%;
    max-width: 450px; /* Sedikit lebih lebar dari sebelumnya */
    transform: translateY(-20px) scale(0.95); /* Efek masuk yang lembut */
    opacity: 0;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    position: relative; /* Untuk posisi tombol close */
}

/* Animasi masuk untuk popup-inner */
.popup-form[style*="display: flex"] .popup-inner {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.popup-inner h2 {
    color: #ffb347; /* Warna judul yang lebih terang */
    text-align: center;
    margin-bottom: 25px;
    font-size: 15px; /* Ukuran font lebih besar */
    text-shadow: 0 0 8px rgba(255,179,71,0.5); /* Sedikit glow pada judul */
    border-bottom: none; /* Hilangkan border bawah yang sudah ada di h2 global */
    padding-bottom: 0;
}

.popup-inner input[type="text"],
.popup-inner input[type="email"],
.popup-inner input[type="number"],
.popup-inner select {
    width: 80%;
    padding: 8px 15px; /* Padding lebih nyaman */
    margin-bottom: 15px; /* Jarak antar input */
    border-radius: 8px; /* Sudut membulat */
    border: 1px solid #4a6fa5; /* Border yang menyatu dengan background */
    background-color: rgba(255, 255, 255, 0.1); /* Background input transparan */
    color: #e0e0e0; /* Warna teks input */
    font-size: 10px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.popup-inner input:focus,
.popup-inner select:focus {
    outline: none;
    border-color: #ff9500; /* Border warna aksen saat fokus */
    box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.3); /* Ring glow saat fokus */
    background-color: rgba(255, 255, 255, 0.15);
}

.popup-inner input::placeholder {
    color: #b0b0b0; /* Warna placeholder */
}

/* Khusus untuk input yang readonly, agar tetap jelas tapi tidak mengganggu */
.popup-inner input[readonly] {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: #3a5b8e;
    cursor: default;
}

/* Modifikasi tombol di dalam popup */
.popup-inner button {
    padding: 8px 10px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.1s ease;
}

.popup-inner button#dep-submit,
.popup-inner button#with-submit,
.popup-inner button#btn-qris {
    background: #ff9500; /* Warna oranye terang */
    color: #222; /* Warna teks lebih gelap untuk kontras */
    box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
}

.popup-inner button#dep-submit:hover,
.popup-inner button#with-submit:hover,
.popup-inner button#btn-qris:hover {
    background: #ffb347; /* Oranye lebih terang saat hover */
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 179, 71, 0.5);
}

.popup-inner button:last-child, /* Tombol Batal */
.popup-inner button#btn-kembali-ewallet {
    background: #5a7ea8; /* Warna abu-biru yang lembut */
    color: #fff;
}

.popup-inner button:last-child:hover,
.popup-inner button#btn-kembali-ewallet:hover {
    background: #6c90b8;
    transform: translateY(-2px);
}

/* Tombol copy */
.btn-copy {
    background: #007bff !important; /* Warna biru konsisten */
    color: white !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 10px !important;
    margin-left: 8px;
    box-shadow: none !important; /* Hilangkan shadow bawaan */
}

.btn-copy:hover {
    background: #0056b3 !important;
    transform: translateY(0px) !important; /* Jangan ada efek naik */
}

/* QRIS Image */
#form-qris img {
    border-radius: 8px;
    border: 2px solid #ff9500; /* Border warna aksen */
    box-shadow: 0 0 15px rgba(255,165,0,0.3);
}

/* --- Modifikasi untuk Game Popup --- */
#game-popup {
    /* Gunakan properti popup-form agar konsisten */
    display: none; /* Tetap sembunyikan secara default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.75) 0%, rgba(0, 0, 0, 0.6) 100%);
    justify-content: center;
    align-items: center;
    z-index: 10000; /* Pastikan game popup di atas popup lainnya */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

#game-popup[style*="display: flex"] {
    opacity: 1;
    visibility: visible;
}

.game-popup-inner {
    background: linear-gradient(145deg, #2a5298, #1e3c72); /* Sama dengan popup lainnya */
    color: #e0e0e0;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 25px 5px rgba(255,165,0,0.3);
    width: 90%;
    max-width: 450px;
    position: relative;
    transform: translateY(-20px) scale(0.95);
    opacity: 0;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
}

#game-popup[style*="display: flex"] .game-popup-inner {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.game-popup-inner .close-button {
    color: #ffb347; /* Warna X yang menyatu */
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 32px; /* Ukuran lebih besar */
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.1s ease;
}

.game-popup-inner .close-button:hover,
.game-popup-inner .close-button:focus {
    color: #fff; /* Putih saat hover */
    transform: rotate(90deg); /* Efek putar saat hover */
    text-decoration: none;
}

.game-popup-inner h2 {
    color: #ffb347;
    text-align: center;
    margin-bottom: 20px;
    border-bottom: none;
    padding-bottom: 0;
    font-size: 26px;
    text-shadow: 0 0 8px rgba(255,179,71,0.5);
}

.game-popup-inner table {
    width: 100%;
    border-collapse: separate; /* Gunakan separate agar border-radius bisa bekerja */
    border-spacing: 0; /* Hilangkan jarak antar sel */
    margin-top: 15px;
    border-radius: 8px; /* Sudut membulat untuk tabel */
    overflow: hidden; /* Pastikan konten tidak meluber */
    box-shadow: 0 2px 10px rgba(0,0,0,0.3); /* Bayangan tabel */
}

.game-popup-inner th, .game-popup-inner td {
    border: 1px solid #3a5b8e; /* Border yang menyatu */
    padding: 12px; /* Padding lebih nyaman */
    text-align: left;
}

.game-popup-inner th {
    background-color: #3e6297; /* Background header tabel */
    color: #f0f0f0; /* Warna teks header */
    font-weight: 700;
}

.game-popup-inner td {
    background-color: #2e4d7e; /* Background sel tabel */
}

.game-popup-inner td a {
    text-decoration: none;
    color: #ffb347; /* Warna tautan game yang serasi */
    display: block;
    padding: 5px 0; /* Agar ada padding di dalam sel */
    transition: color 0.2s ease;
}

.game-popup-inner td a:hover {
    color: #fff; /* Warna putih saat hover */
    text-decoration: underline;
}
  </style>
</head>
<body>
  <div class="container">
  <h1>Profil Pemain</h1>
  <div class="saldo" id="saldo-display">Saldo: Rp0</div>
  <div class="btn-group">
    <button class="btn" id="btn-deposit">Deposit</button>
    <button class="btn" id="btn-withdraw">Penarikan</button>
    <button class="btn" id="btn-main-game">Mainkan Game</button>
  </div>

  <h2>Riwayat Deposit</h2>
  <table id="riwayat-deposit">
    <thead><tr><th>Tanggal</th><th>Jumlah (Rp)</th><th>Status</th></tr></thead>
    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
  </table>

  <h2>Riwayat Penarikan</h2>
  <table id="riwayat-penarikan">
    <thead><tr><th>Tanggal</th><th>Jumlah (Rp)</th><th>Status</th></tr></thead>
    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
  </table>
</div>

<div id="popup-deposit" class="popup-form" style="display:none;">
  <div class="popup-inner">
    <h2>Deposit via DANA</h2>
    <input type="text" id="dep-nama" placeholder="Nama" readonly />
    <input type="email" id="dep-email" placeholder="Email" readonly style="margin-bottom: 12px;" />
    <div style="display: flex; align-items: center; margin-bottom: 12px;">
      <input type="text" id="dep-nomor" placeholder="Nomor" readonly style="flex-grow: 1; margin-bottom: 0;" />
      <button class="btn-copy" data-target="dep-nomor" style="margin-left: 8px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
        Salin
      </button>
    </div>

    <div style="text-align:center; margin: 12px 0;">
      <button id="btn-qris" style="background:#ff9500; padding:8px 16px; border:none; border-radius:6px; color:#fff; cursor:pointer;">QRIS</button>
    </div>
    
    <div style="text-align:center; margin: 12px 0;">
      <button id="btn-kembali-ewallet" style="background:#888; padding:6px 16px; border:none; border-radius:6px; color: #fff; cursor:pointer; display:none;">Kembali ke eWallet</button>
    </div>

    <div id="form-qris" style="display:none; text-align:center;">
      <img src="" alt="QRIS" id="gambar-qris" style="max-width: 100%; height: auto; margin: 10px 0;" />
    </div>

    <input type="number" id="dep-jumlah" placeholder="Jumlah (Rp)" />
    <button id="dep-submit">Kirim</button>
    <button onclick="closePopup('popup-deposit')">Batal</button>
  </div>
</div>

<div id="popup-withdraw" class="popup-form" style="display:none;">
  <div class="popup-inner">
    <h2>Penarikan</h2>
    <input type="text" id="with-nama" placeholder="Nama" />
    <input type="email" id="with-email" placeholder="Email" readonly style="margin-bottom: 12px;" />
    <div style="display: flex; align-items: center; margin-bottom: 12px;">
      <input type="text" id="with-nomor" placeholder="Nomor" />
      </button>
    </div>

    <select id="with-metode">
      <option value="">Pilih e-Wallet</option>
      <option value="DANA">DANA</option>
      <option value="OVO">OVO</option>
      <option value="GoPay">GoPay</option>
    </select>
    <input type="number" id="with-jumlah" placeholder="Jumlah (Rp)" />
    <button id="with-submit">Kirim</button>
    <button onclick="closePopup('popup-withdraw')">Batal</button>
  </div>
</div>

<div id="game-popup" class="popup-form">
  <div class="game-popup-inner">
    <span class="close-button">&times;</span>
    <h2>Pilih Game</h2>
    <table>
      <thead>
        <tr>
          <th>Game</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="slot.html">Slot Game Zone One</a></td>
        </tr>
        <tr>
          <td><a href="poker.html">Poker Game Zone one</a></td>
        </tr>
        <tr>
        <td><a href="tebakdadu.html">Tebak Dadu Game Zone One</a></td>
        </tr>
        <tr>
        <tr><td><a href="samgong.html">Samgong Game Zone one</a></td>
        </tr>
        <tr>
          <td><a href="susunbalok99.html">Susun Balok Game Zone One</a></td>
        </tr>
        </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://vqmfachxnjyxwuavpgds.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
  );

  let uid = localStorage.getItem('uid'); // Menggunakan `let` agar bisa diubah

  
  async function getCurrentUserEmail() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error) {
      console.error('Error fetching user from Supabase auth:', error.message);
      return null;
    }
    
    if (user && uid !== user.id) {
        uid = user.id;
        localStorage.setItem('uid', user.id);
    }
    return user ? user.email : null;
  }

document.addEventListener('DOMContentLoaded', () => {
  
  getCurrentUserEmail().then(() => {
    loadProfile();
  }).catch(err => {
    console.error("Failed to initialize user session:", err);
    
    alert("Sesi pengguna tidak valid. Silakan login kembali.");
    window.location.href = 'login.html'; 
  });

  document.querySelectorAll('.btn-copy').forEach(button => {
    button.addEventListener('click', (event) => {
      const targetId = event.currentTarget.dataset.target;
      const inputElement = document.getElementById(targetId);
      if (inputElement) {
        inputElement.select();
        inputElement.setSelectionRange(0, 99999); 
        try {
          navigator.clipboard.writeText(inputElement.value)
            .then(() => {
              alert('Nomor berhasil disalin: ' + inputElement.value);
            })
            .catch(err => {
              console.error('Gagal menyalin teks: ', err);
              alert('Gagal menyalin nomor. Silakan salin manual.');
            });
        } catch (err) {
          // Fallback for older browsers
          document.execCommand('copy');
          alert('Nomor berhasil disalin: ' + inputElement.value);
        }
      }
    });
  });

  // --- NEW JAVASCRIPT for Game Popup ---
  const gamePopup = document.getElementById('game-popup');
  const closeGamePopupBtn = gamePopup.querySelector('.close-button');
  const mainGameBtn = document.getElementById('btn-main-game'); // Ambil referensi tombol main game

  // Event listener untuk tombol "Mainkan Game"
  mainGameBtn.addEventListener('click', function() {
    // Hapus class loading jika ada (dari kode Anda sebelumnya)
    mainGameBtn.classList.remove('loading');
    
    // Tampilkan popup game
    gamePopup.style.display = 'flex';
  });

  // Event listener untuk tombol tutup (X) di popup game
  closeGamePopupBtn.addEventListener('click', function() {
    gamePopup.style.display = 'none';
  });

  // Event listener untuk menutup popup game saat mengklik di luar area konten
  window.addEventListener('click', function(event) {
    if (event.target == gamePopup) {
      gamePopup.style.display = 'none';
    }
  });
  // --- END NEW JAVASCRIPT for Game Popup ---
});

  async function loadProfile() {
    if (!uid) {
        console.warn('UID tidak ditemukan. Tidak dapat memuat profil pengguna.');
        document.getElementById('saldo-display').textContent = 'Saldo: Rp0 (Harap Login)';
        document.querySelector('#riwayat-deposit tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>'; // colspan 3
        document.querySelector('#riwayat-penarikan tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>'; // colspan 3
        return; 
    }

    const { data: userData, error: userError } = await supabase
      .from('users_data')
      .select('saldo')
      .eq('user_id', uid)
      .single();

    if (userError && userError.code !== 'PGRST116') { // PGRST116 adalah kode untuk "No rows found"
      console.error('Error memuat data saldo:', userError.message);
      alert('Gagal memuat data saldo: ' + userError.message);
      document.getElementById('saldo-display').textContent = `Saldo: Rp0 (Error)`;
      return;
    } else if (userError && userError.code === 'PGRST116') {
        
        console.warn('Pengguna baru, membuat entri saldo awal...');
        document.getElementById('saldo-display').textContent = `Saldo: Rp0 (Baru)`;
        const { error: insertError } = await supabase
            .from('users_data')
            .insert([{ user_id: uid, saldo: 0 }]);

        if (insertError) {
            console.error('Error saat membuat entri saldo awal:', insertError.message);
            alert('Gagal membuat entri saldo awal. Cek log.');
            document.getElementById('saldo-display').textContent = `Saldo: Rp0 (Error Inisialisasi)`;
        }
        
    } else {
        document.getElementById('saldo-display').textContent = `Saldo: Rp${userData.saldo ?? 0}`;
    }

    
    const { data: depositData, error: depHistoryError } = await supabase
      .from('deposit_requests') 
      .select('created_at, amount, status') 
      .eq('user_id', uid)
      .order('created_at', { ascending: false });

    const depositTableBody = document.querySelector('#riwayat-deposit tbody');
    depositTableBody.innerHTML = ''; // Kosongkan tabel sebelum mengisi
    if (depHistoryError) {
        console.error('Error fetching deposit history:', depHistoryError.message);
        depositTableBody.innerHTML = '<tr><td colspan="3" class="empty">Gagal memuat riwayat deposit.</td></tr>';
    } else if (!depositData || depositData.length === 0) {
      depositTableBody.innerHTML = '<tr><td colspan="3" class="empty">Belum ada riwayat deposit.</td></tr>'; 
    } else {
      depositData.forEach(row => {
        const date = new Date(row.created_at).toLocaleString('id-ID');
        const statusClass = `status-${row.status}`; 
        depositTableBody.innerHTML += `<tr><td>${date}</td><td>Rp${row.amount.toLocaleString('id-ID')}</td><td class="${statusClass}">${row.status.charAt(0).toUpperCase() + row.status.slice(1)}</td></tr>`; 
      });
    }

    
    const { data: withdrawData, error: withdrawHistoryError } = await supabase
      .from('withdraw_requests') 
      .select('created_at, amount, status') 
      .eq('user_id', uid)
      .order('created_at', { ascending: false });

    const withdrawTableBody = document.querySelector('#riwayat-penarikan tbody');
    withdrawTableBody.innerHTML = ''; // Kosongkan tabel sebelum mengisi
    if (withdrawHistoryError) {
        console.error('Error fetching withdraw history:', withdrawHistoryError.message);
        withdrawTableBody.innerHTML = '<tr><td colspan="3" class="empty">Gagal memuat riwayat penarikan.</td></tr>';
    } else if (!withdrawData || withdrawData.length === 0) {
      withdrawTableBody.innerHTML = '<tr><td colspan="3" class="empty">Belum ada riwayat penarikan.</td></tr>'; 
    } else {
      withdrawData.forEach(row => {
        const date = new Date(row.created_at).toLocaleString('id-ID');
        const statusClass = `status-${row.status}`; 
        withdrawTableBody.innerHTML += `<tr><td>${date}</td><td>Rp${row.amount.toLocaleString('id-ID')}</td><td class="${statusClass}">${row.status.charAt(0).toUpperCase() + row.status.slice(1)}</td></tr>`; 
      });
    }
  }

  function closePopup(id) {
    document.getElementById(id).style.display = 'none';
  }

  document.getElementById('btn-deposit').onclick = async () => {
    if (!uid) { alert("Anda harus login untuk melakukan deposit."); return; }
    document.getElementById('popup-deposit').style.display = 'flex';
    const userEmail = await getCurrentUserEmail();
    if (userEmail) {
      document.getElementById('dep-email').value = userEmail;
    }

    // Default: tampilkan eWallet info
    const { data, error } = await supabase
      .from('deposit_config')
      .select('*')
      .eq('metode', 'eWallet')
      .single();

    if (error || !data) {
      alert('Gagal ambil data eWallet.');
      return;
    }

    document.getElementById('dep-nama').value = data.nama;
    document.getElementById('dep-nomor').value = data.nomor;
    document.getElementById('dep-submit').dataset.metode = 'eWallet';
  };

  document.getElementById('btn-qris').onclick = async () => {
    const { data, error } = await supabase
      .from('deposit_config')
      .select('*')
      .eq('metode', 'QRIS')
      .single();

    if (error || !data) {
      alert('Gagal ambil data QRIS.');
      return;
    }

    document.getElementById('form-qris').style.display = 'block';
    document.getElementById('gambar-qris').src = data.qris_url;
    document.getElementById('dep-submit').dataset.metode = 'QRIS';

    // Tampilkan tombol kembali
    document.getElementById('btn-kembali-ewallet').style.display = 'inline-block';
  };

  document.getElementById('btn-kembali-ewallet').onclick = async () => {
    const { data, error } = await supabase
      .from('deposit_config')
      .select('*')
      .eq('metode', 'eWallet')
      .single();

    if (error || !data) {
      alert('Gagal ambil data eWallet.');
      return;
    }

    document.getElementById('form-qris').style.display = 'none';
    document.getElementById('dep-nama').value = data.nama;
    document.getElementById('dep-nomor').value = data.nomor;
    document.getElementById('dep-submit').dataset.metode = 'eWallet';

    document.getElementById('btn-kembali-ewallet').style.display = 'none';
  };

  document.getElementById('dep-submit').onclick = async () => {
    if (!uid) { alert("Anda harus login untuk melakukan deposit."); return; }
    const nama = document.getElementById('dep-nama').value;
    const email = document.getElementById('dep-email').value;
    const nomor = document.getElementById('dep-nomor').value;
    const jumlah = document.getElementById('dep-jumlah').value;
    const metode = 'eWallet'; 

    if (!nama || !nomor || !jumlah || !email) {
      alert("Lengkapi semua kolom.");
      return;
    }

  
    const depositTableBody = document.querySelector('#riwayat-deposit tbody');
    const now = new Date();
    const dateString = now.toLocaleString('id-ID');
     const newRowHTML = `<tr class="pending-item" data-id="temp-${Date.now()}"><td>${dateString}</td><td>Rp${parseInt(jumlah).toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;
    
  
    if (depositTableBody.querySelector('.empty')) {
      depositTableBody.innerHTML = ''; 
    }
    
    
    depositTableBody.insertAdjacentHTML('afterbegin', newRowHTML);
  

  
    const { error } = await supabase.from('deposit_requests').insert([
      { user_id: uid, nama, metode, amount: parseInt(jumlah), status: 'pending', email: email }
    ]);

    if (error) {
      console.error(error);
      alert("Gagal kirim deposit. Silakan coba lagi.");
      // --- START: Jika ada error, hapus atau ubah status "pending" yang instan tadi ---
      const tempRow = depositTableBody.querySelector(`[data-id="temp-${now.getTime()}"]`); 
      if (tempRow) {
          tempRow.remove(); 
      }
      // --- END: Jika ada error ---
    } else {
      alert("Permintaan deposit dikirim. ..");
      closePopup('popup-deposit');
      loadProfile();
    }
  };

  document.getElementById('btn-withdraw').onclick = async () => { 
    if (!uid) { alert("Anda harus login untuk melakukan penarikan."); return; }
    document.getElementById('popup-withdraw').style.display = 'flex';
    const userEmail = await getCurrentUserEmail(); 
    if (userEmail) {
      document.getElementById('with-email').value = userEmail; 
    }
  };

  document.getElementById('with-submit').onclick = async () => {
    if (!uid) { alert("Anda harus login untuk melakukan penarikan."); return; }

    const nama = document.getElementById('with-nama').value;
    const email = document.getElementById('with-email').value;
    const metode = document.getElementById('with-metode').value;
    const nomor = document.getElementById('with-nomor').value;
    const jumlah = parseInt(document.getElementById('with-jumlah').value); 

    if (!nama || !metode || !nomor || !jumlah || !email) {
      alert("Lengkapi semua kolom.");
      return;
    }

    if (isNaN(jumlah) || jumlah <= 0) { 
        alert("Jumlah penarikan harus angka positif.");
        return;
    }

    
    const { data: userData, error: saldoError } = await supabase
        .from('users_data')
        .select('saldo')
        .eq('user_id', uid)
        .single();

    if (saldoError && saldoError.code !== 'PGRST116') { 
        console.error('Error fetching user saldo for withdraw:', saldoError);
        alert('Gagal mengambil saldo user untuk penarikan. Silakan coba lagi.');
        return;
    } else if (saldoError && saldoError.code === 'PGRST116' || (userData && userData.saldo === null)) {
        alert('Saldo Anda 0. Tidak bisa melakukan penarikan.');
        return;
    }
    
    const currentSaldo = userData.saldo;

    if (jumlah > currentSaldo) {
        alert(`Saldo tidak mencukupi. Saldo Anda saat ini adalah Rp${currentSaldo.toLocaleString('id-ID')}.`);
        return; 
    }

  
    const withdrawTableBody = document.querySelector('#riwayat-penarikan tbody');
    const now = new Date();
    const dateString = now.toLocaleString('id-ID'); // Format ta
    
    const newRowHTML = `<tr class="pending-item" data-id="temp-${Date.now()}"><td>${dateString}</td><td>Rp${jumlah.toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;
     if (withdrawTableBody.querySelector('.empty')) {
      withdrawTableBody.innerHTML = ''; 
    }
    
    withdrawTableBody.insertAdjacentHTML('afterbegin', newRowHTML);
    

    
    const saldoBaru = currentSaldo - jumlah;
    
    const { error: updateSaldoError } = await supabase
        .from('users_data')
               .update({ saldo: saldoBaru })
        .eq('user_id', uid);

    if (updateSaldoError) {
        console.error('Error updating saldo during withdraw request:', updateSaldoError);
        alert('Gagal mengurangi saldo. Silakan coba lagi. Saldo Anda tidak berkurang.');
        const tempRow = withdrawTableBody.querySelector(`[data-id="temp-${now.getTime()}"]`);
        if (tempRow) {
            tempRow.remove(); 
        }
        return; 
    }

    document.getElementById('saldo-display').textContent = `Saldo: Rp${saldoBaru.toLocaleString('id-ID')}`;

    
    const { error: insertRequestError } = await supabase
        .from('withdraw_requests')
        .insert([
            { user_id: uid, nama, metode, amount: jumlah, email: email, status: 'pending' }
        ]);

    if (insertRequestError) {
        console.error('Error inserting withdraw request:', insertRequestError);
        alert('Gagal mencatat permintaan penarikan. Saldo Anda akan dikembalikan. Silakan coba lagi.');
        
        const { error: refundError } = await supabase
            .from('users_data')
            .update({ saldo: currentSaldo }) 
            .eq('user_id', uid);

        if (refundError) {
            console.error('CRITICAL ERROR: Gagal mengembalikan saldo setelah permintaan penarikan gagal dicatat:', refundError);
            alert('KRITIS: Saldo gagal dikembalikan setelah permintaan penarikan gagal dicatat. MOHON SEGERA HUBUNGI ADMIN!');
        } else {
            document.getElementById('saldo-display').textContent = `Saldo: Rp${currentSaldo.toLocaleString('id-ID')}`;
        }

        const tempRow = withdrawTableBody.querySelector(`[data-id="temp-${now.getTime()}"]`);
        if (tempRow) {
            tempRow.remove();
        }
    } else {
        alert('Permintaan penarikan dikirim dan saldo berhasil dikurangi. Menunggu proses admin.');
        closePopup('popup-withdraw');
        loadProfile(); 
    }
  };


  // --- OLD btn-main-game handler, akan diganti oleh yang baru ---
  // document.getElementById('btn-main-game').onclick = () => {
  // const mainGameBtn = document.getElementById('btn-main-game');
  // mainGameBtn.classList.add('loading');

  // setTimeout(() => {
  //   window.location.href = 'slot.html';
  // }, 4000); 
  // };
  // --- END OLD btn-main-game handler ---

</script>
</body>
</html>
